{
	"name": "SILVER_TRANSFORMATION_FOTOGRAFIAS_POSSIVEIS",
	"properties": {
		"activities": [
			{
				"name": "Insere Novas Fotografias Possiveis",
				"type": "Script",
				"dependsOn": [
					{
						"activity": "Wait1",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SelfHosted Lake",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "DECLARE @dtc_cadastro_prox_d_util AS DATE,\n@cod_calendario as numeric\n\nSelect @cod_calendario =  cod_calendario_monetario\nfrom silver.calendario_monetario\nwhere sts_ativo = 1\n\nSET @cod_calendario = (select cod_calendario_monetario\nfrom silver.calendario_monetario\nwhere sts_ativo = 1)\n\nSET @dtc_cadastro_prox_d_util = ( SELECT TOP 1\n    CAST(dtc_final as date) AS dtc_final\nFROM Silver.calendario_monetario\nWHERE cod_calendario_monetario = @cod_calendario\n\t\t\t\t\t\t\t\t)\n\nIF (@dtc_cadastro_prox_d_util IS NULL)\n        THROW 50000, 'Data_Final: Nao existe calendario monetario para a data selecionada' , 1;\n\nWHILE 1 = 1\n    BEGIN\n    IF DATEPART(WEEKDAY, @dtc_cadastro_prox_d_util) NOT IN (7, 1)\n        AND FORMAT(@dtc_cadastro_prox_d_util, 'ddMM') NOT IN (SELECT FORMAT(dtc_feriado, 'ddMM')\n        FROM silver.feriado)\n          BREAK\n    SET @dtc_cadastro_prox_d_util = DATEADD(DAY, 1, @dtc_cadastro_prox_d_util)\nEND\n\nINSERT INTO silver.fotografias_possiveis\n    ( cod_calendario_monetario ,\n    sig_escritorio_contratado ,\n    cod_divisao_processo ,\n    dtc_cadastro ,\n    nom_cadastro_responsavel ,\n    sts_ativo ,\n    nom_usuario_responsavel ,\n    dtc_data_fotografia ,\n    nom_usuario_fotografo ,\n    dtc_inicial ,\n    dtc_final ,\n    dtc_limite_foto ,\n    nom_usuario_cadastro ,\n    nom_escritorio_contratado ,\n    nom_escritorio_sap ,\n    sig_divisao ,\n    nom_divisao ,\n    qtd_processo ,\n    desc_calendario)\nSELECT distinct\n    cm.cod_calendario_monetario,\n    p.sig_escritorio_contratado,\n    p.cod_divisao_processo,\n    -- CONCAT(p.cod_divisao_processo,p.sig_escritorio_contratado,cod_calendario_monetario) as cod_fotografia,\n    -- Cast ( CONCAT( Right( d.pos, 5), p.cod_divisao_processo,cod_calendario_monetario) as int )  as cod_fotografia,\n    '20220101' as dtc_cadastro,\n    'Telefonica' as nom_cadastro_responsavel ,\n    '1' as sts_ativo,\n    'Telefonica' as nom_usuario_responsavel ,\n    '20220101' as dtc_data_fotografia,\n    'Telefonica'  as nom_usuario_fotografo,\n    cm.dtc_inicial,\n    cm.dtc_final,\n    cm.dtc_limite_foto,\n    cm.nom_usuario_cadastro,\n    d.nom_escritorio_contratado,\n    d.nom_escritorio_contratado as nom_escritorio_sap,\n    c.sig_divisao,\n    c.nom_divisao,\n    count(p.num_processo),\n    cm.desc_calendario\nFROM\n    dbo.dm_divisao_processo c,\n    silver.escritorio_contratado d,\n    --silver.escritorio_contratado_sap e ,\n    silver.processo AS p\n\n    --JOIN silver.calendario_monetario AS cm ON cm.cod_calendario_monetario = @cod_calendario\n    JOIN silver.modulo_natureza AS mn\n    ON mn.cod_natureza = p.cod_natureza\n        AND mn.cod_especificacao_natureza = p.cod_especificacao_natureza\n        AND mn.cod_detalhe_especific_natureza = p.cod_detalhe_especific_natureza\n    JOIN silver.calendario_monetario AS cm ON (1=1\n        and ( ( p.sts_ativo = '1' AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final )\n        OR ( p.sts_ativo = '0'\n        AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final\n        AND CAST(p.dtc_fim AS DATE) >= cm.dtc_final\n            )\n        OR ( p.sts_ativo = '2'\n        AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final\n        AND CAST(p.dtc_fim AS DATE) >= cm.dtc_final\n            )\n        OR (  p.sts_ativo = '0'\n        AND p.dtc_fim BETWEEN cm.dtc_inicial AND cm.dtc_final\n         )\n        OR (  p.sts_ativo = '2'\n        AND p.dtc_fim BETWEEN cm.dtc_inicial AND cm.dtc_final\n            )\n       )) and cm.cod_calendario_monetario = @cod_calendario\n    JOIN silver.modulo AS m\n    ON m.cod_modulo = mn.cod_modulo\n    left join dbo.ft_fotografia ftf\n    on(ftf.NUM_PROCESSO = p.num_processo\n        and ftf.COD_CALENDARIO_MONETARIO = cm.COD_CALENDARIO_MONETARIO)\nWHERE \n    CONCAT(cm.cod_calendario_monetario, p.sig_escritorio_contratado, p.cod_divisao_processo) NOT IN (SELECT CONCAT(cod_calendario_monetario, sig_escritorio_contratado, cod_divisao_processo)\n    FROM SILVER.FOTOGRAFIAS_POSSIVEIS)\n    AND p.sts_excluido = '0'\n    and d.sig_escritorio_contratado =  p.sig_escritorio_contratado\n    -- and e.sig_escritorio_contratado =  p.sig_escritorio_contratado\n    and p.cod_divisao_processo = c.cod_divisao_processo\n    AND p.sts_excluido = '0'\n    AND p.COD_DIVISAO_PROCESSO >0\n    AND ( mn.cod_modulo != '5'\n    OR ( p.cod_tipo_acao_processo <> '51'\n    OR p.cod_tipo_acao_processo IS NULL\n            )\n       )\n    AND NOT ( p.cod_natureza = '100'\n        AND p.cod_especificacao_natureza = '3'\n        AND p.cod_detalhe_especific_natureza = '6'\n           )\n    AND NOT EXISTS ( SELECT 1\n    FROM silver.terceiro_interessado AS ti\n        JOIN silver.parte_processo AS pp\n        ON pp.cod_parte_processo = ti.cod_parte_processo\n    WHERE ti.cod_empresa = p.cod_empresa\n        AND ti.num_processo = p.num_processo\n        AND pp.sts_empresa_operadora = '1'\n                   )\n    AND ( mn.cod_modulo != '4'\n    OR NOT ( ( NOT EXISTS ( SELECT 1\n        FROM silver.autor AS a\n            JOIN silver.parte_processo AS pp\n            ON pp.cod_parte_processo = a.cod_parte_processo\n        WHERE a.num_processo = p.num_processo\n            AND a.cod_empresa = p.cod_empresa\n            AND pp.sts_empresa_operadora = '1'\n                               )\n                  )\n        AND ( NOT EXISTS ( SELECT 1\n        FROM silver.reu AS r\n            JOIN silver.parte_processo AS pp\n            ON pp.cod_parte_processo = r.cod_parte_processo\n        WHERE r.num_processo = p.num_processo\n            AND r.cod_empresa = p.cod_empresa\n            AND pp.sts_empresa_operadora = '1'\n                                   )\n                      )\n        AND ( EXISTS ( SELECT 1\n        FROM silver.vitima AS v\n            JOIN silver.parte_processo AS pp\n            ON pp.cod_parte_processo = v.cod_parte_processo\n        WHERE v.num_processo = p.num_processo\n            AND v.cod_empresa = p.cod_empresa\n            AND pp.sts_empresa_operadora = '1'\n                               )\n                      )\n                )\n       )\n    AND ( CAST(log_dtc_citacao AS DATE) <= ( SELECT top 1\n        cmAtual.dtc_final\n    FROM silver.calendario_monetario cmAtual\n    WHERE cmAtual.cod_calendario_monetario = cm.cod_calendario_monetario\n                                                )\n    OR log_dtc_citacao IS NULL \n       )\n    and ((sts_area_responsavel is null) or (sts_area_responsavel is not null and sts_area_responsavel <> 'REG'))\n    and (sts_area_responsavel_geral is null or sts_area_responsavel_geral <> 'PSE')\ngroup by p.cod_divisao_processo, p.sig_escritorio_contratado,cm.cod_calendario_monetario,d.pos,cm.dtc_inicial,cm.dtc_final\n   ,cm.dtc_limite_foto ,cm.nom_usuario_cadastro,\n      d.nom_escritorio_contratado,   c.sig_divisao,   c.nom_divisao , cm.desc_calendario\n\n\n\n\n\ndelete TGT\nfrom silver.fotografias_possiveis TGT\nwhere 1=1\n    and cod_calendario_monetario = @cod_calendario\n    and not exists\n    (SELECT 1\n    FROM\n        dbo.dm_divisao_processo c,\n        silver.escritorio_contratado d,\n        --silver.escritorio_contratado_sap e ,\n        silver.processo AS p\n        --JOIN silver.calendario_monetario AS cm ON cm.cod_calendario_monetario = @cod_calendario\n        JOIN silver.modulo_natureza AS mn\n        ON mn.cod_natureza = p.cod_natureza\n            AND mn.cod_especificacao_natureza = p.cod_especificacao_natureza\n            AND mn.cod_detalhe_especific_natureza = p.cod_detalhe_especific_natureza\n        JOIN silver.calendario_monetario AS cm ON (1=1\n            and ( ( p.sts_ativo = '1' AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final )\n            OR ( p.sts_ativo = '0'\n            AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final\n            AND CAST(p.dtc_fim AS DATE) >= cm.dtc_final\n            )\n            OR ( p.sts_ativo = '2'\n            AND CAST(p.dtc_cadastro AS DATE) <= cm.dtc_final\n            AND CAST(p.dtc_fim AS DATE) >= cm.dtc_final\n            )\n            OR (  p.sts_ativo = '0'\n            AND p.dtc_fim BETWEEN cm.dtc_inicial AND cm.dtc_final\n         )\n            OR (  p.sts_ativo = '2'\n            AND p.dtc_fim BETWEEN cm.dtc_inicial AND cm.dtc_final\n            )\n       )) and cm.cod_calendario_monetario = @cod_calendario\n        JOIN silver.modulo AS m\n        ON m.cod_modulo = mn.cod_modulo\n        left join dbo.ft_fotografia ftf\n        on(ftf.NUM_PROCESSO = p.num_processo\n            and ftf.COD_CALENDARIO_MONETARIO = cm.COD_CALENDARIO_MONETARIO)\n    WHERE\n        1=1\n        AND p.sts_excluido = '0'\n        AND d.sig_escritorio_contratado =  p.sig_escritorio_contratado\n        -- and e.sig_escritorio_contratado =  p.sig_escritorio_contratado\n        AND p.cod_divisao_processo = c.cod_divisao_processo\n        AND p.sts_excluido = '0'\n        AND p.COD_DIVISAO_PROCESSO >0\n        AND ( mn.cod_modulo != '5'\n        OR ( p.cod_tipo_acao_processo <> '51'\n        OR p.cod_tipo_acao_processo IS NULL\n            )\n       )\n        AND NOT ( p.cod_natureza = '100'\n            AND p.cod_especificacao_natureza = '3'\n            AND p.cod_detalhe_especific_natureza = '6'\n           )\n        AND NOT EXISTS ( SELECT 1\n        FROM silver.terceiro_interessado AS ti\n            JOIN silver.parte_processo AS pp\n            ON pp.cod_parte_processo = ti.cod_parte_processo\n        WHERE ti.cod_empresa = p.cod_empresa\n            AND ti.num_processo = p.num_processo\n            AND pp.sts_empresa_operadora = '1'\n                   )\n        AND ( mn.cod_modulo != '4'\n        OR NOT ( ( NOT EXISTS ( SELECT 1\n            FROM silver.autor AS a\n                JOIN silver.parte_processo AS pp\n                ON pp.cod_parte_processo = a.cod_parte_processo\n            WHERE a.num_processo = p.num_processo\n                AND a.cod_empresa = p.cod_empresa\n                AND pp.sts_empresa_operadora = '1'\n                               )\n                  )\n            AND ( NOT EXISTS ( SELECT 1\n            FROM silver.reu AS r\n                JOIN silver.parte_processo AS pp\n                ON pp.cod_parte_processo = r.cod_parte_processo\n            WHERE r.num_processo = p.num_processo\n                AND r.cod_empresa = p.cod_empresa\n                AND pp.sts_empresa_operadora = '1'\n                                   )\n                      )\n            AND ( EXISTS ( SELECT 1\n            FROM silver.vitima AS v\n                JOIN silver.parte_processo AS pp\n                ON pp.cod_parte_processo = v.cod_parte_processo\n            WHERE v.num_processo = p.num_processo\n                AND v.cod_empresa = p.cod_empresa\n                AND pp.sts_empresa_operadora = '1'\n                               )\n                      )\n                )\n       )\n        AND ( CAST(log_dtc_citacao AS DATE) <= ( SELECT top 1\n            cmAtual.dtc_final\n        FROM silver.calendario_monetario cmAtual\n        WHERE cmAtual.cod_calendario_monetario = cm.cod_calendario_monetario\n                                                )\n        OR log_dtc_citacao IS NULL \n       )\n        and ((sts_area_responsavel is null) or (sts_area_responsavel is not null and sts_area_responsavel <> 'REG'))\n        and (sts_area_responsavel_geral is null or sts_area_responsavel_geral <> 'PSE')\n    group by p.cod_divisao_processo, p.sig_escritorio_contratado,cm.cod_calendario_monetario,d.pos,cm.dtc_inicial,cm.dtc_final\n   ,cm.dtc_limite_foto ,cm.nom_usuario_cadastro,\n      d.nom_escritorio_contratado,   c.sig_divisao,   c.nom_divisao , cm.desc_calendario    )\n\n"
						}
					]
				}
			},
			{
				"name": "Wait1",
				"type": "Wait",
				"dependsOn": [],
				"userProperties": [],
				"typeProperties": {
					"waitTimeInSeconds": 150
				}
			}
		],
		"folder": {
			"name": "SILVER"
		},
		"annotations": [],
		"lastPublishTime": "2022-12-16T20:51:30Z"
	},
	"type": "Microsoft.Synapse/workspaces/pipelines"
}