{
	"name": "Carga Fotos Possiveis",
	"properties": {
		"content": {
			"query": "DECLARE @dtc_cadastro_prox_d_util AS DATE,\n@cod_calendario as numeric\n\nSelect @cod_calendario =  cod_calendario_monetario \nfrom silver.calendario_monetario\nwhere sts_ativo = 1 \n\nSET @cod_calendario = 156\n\nSET @dtc_cadastro_prox_d_util = ( SELECT TOP 1 CAST(dtc_final as date) AS dtc_final\n                                    FROM Silver.calendario_monetario\n                                    WHERE cod_calendario_monetario = @cod_calendario\n\t\t\t\t\t\t\t\t)\n\nIF (@dtc_cadastro_prox_d_util IS NULL)\n        THROW 50000, 'Data_Final: Nao existe calendario monetario para a data selecionada' , 1;\n\n    WHILE 1 = 1\n    BEGIN\n        IF DATEPART(WEEKDAY, @dtc_cadastro_prox_d_util) NOT IN (7, 1)\n           AND FORMAT(@dtc_cadastro_prox_d_util, 'ddMM') NOT IN (SELECT FORMAT(dtc_feriado, 'ddMM') FROM silver.feriado)\n          BREAK\n    \tSET @dtc_cadastro_prox_d_util = DATEADD(DAY, 1, @dtc_cadastro_prox_d_util)\n    END\n\n\nINSERT INTO silver.fotografias_possiveis\n(\tcod_calendario_monetario   ,\n     sig_escritorio_contratado  ,\n     cod_divisao_processo   ,\n\t dtc_cadastro  ,\n\t nom_cadastro_responsavel  ,\n\t sts_ativo  ,\n\t nom_usuario_responsavel  ,\n\t dtc_data_fotografia  ,\n\t nom_usuario_fotografo  , \n\tdtc_inicial  , \n    dtc_final  ,\n    dtc_limite_foto  ,\n    nom_usuario_cadastro  ,\n    nom_escritorio_contratado  ,\n    nom_escritorio_sap  ,\n    sig_divisao  ,\n   nom_divisao  ,\n   qtd_processo ,\n   desc_calendario)\nSELECT distinct \n   cm.cod_calendario_monetario,\n   p.sig_escritorio_contratado,\n   p.cod_divisao_processo,\n  -- CONCAT(p.cod_divisao_processo,p.sig_escritorio_contratado,cod_calendario_monetario) as cod_fotografia,\n -- Cast ( CONCAT( Right( d.pos, 5), p.cod_divisao_processo,cod_calendario_monetario) as int )  as cod_fotografia,\n   '20220101' as dtc_cadastro,\n   'Telefonica' as nom_cadastro_responsavel ,\n\t '1' as sts_ativo,\n\t 'Telefonica' as nom_usuario_responsavel ,\n    '20220101' as dtc_data_fotografia,\n\t 'Telefonica'  as nom_usuario_fotografo,\n   cm.dtc_inicial, \n   cm.dtc_final,\n   cm.dtc_limite_foto,\n   cm.nom_usuario_cadastro,\n   d.nom_escritorio_contratado,\n   d.nom_escritorio_contratado as nom_escritorio_sap,\n   c.sig_divisao,\n   c.nom_divisao,\n   count(p.num_processo),\n   cm.desc_calendario\n\n  FROM \n    dbo.dm_divisao_processo c,\n  silver.escritorio_contratado d,\n  --silver.escritorio_contratado_sap e ,\n  silver.processo AS p\n\n  JOIN silver.calendario_monetario AS cm ON cm.cod_calendario_monetario = @cod_calendario\n  JOIN silver.modulo_natureza AS mn\n  ON mn.cod_natureza = p.cod_natureza\n  AND mn.cod_especificacao_natureza = p.cod_especificacao_natureza\n  AND mn.cod_detalhe_especific_natureza = p.cod_detalhe_especific_natureza\n  JOIN silver.modulo AS m\n    ON m.cod_modulo = mn.cod_modulo\n  WHERE p.sts_excluido = '0'\n  and d.sig_escritorio_contratado =  p.sig_escritorio_contratado\n -- and e.sig_escritorio_contratado =  p.sig_escritorio_contratado\n  and p.cod_divisao_processo = c.cod_divisao_processo\n   and p.cod_divisao_processo > 0\n\n   AND ( ( p.sts_ativo = '1' AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util )\n         OR ( p.sts_ativo = '0'\n              AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util\n              AND CAST(p.dtc_fim AS DATE) >= @dtc_cadastro_prox_d_util\n            )\n         OR ( p.sts_ativo = '2'\n              AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util\n              AND CAST(p.dtc_fim AS DATE) >= @dtc_cadastro_prox_d_util\n            )\n       )\n   AND ( mn.cod_modulo != '5'\n         OR ( p.cod_tipo_acao_processo <> '51'\n              OR p.cod_tipo_acao_processo IS NULL\n            )\n       )\n   AND NOT ( p.cod_natureza = '100'\n             AND p.cod_especificacao_natureza = '3'\n             AND p.cod_detalhe_especific_natureza = '6'\n           )\n   AND NOT EXISTS ( SELECT 1\n                      FROM silver.terceiro_interessado AS ti\n                      JOIN silver.parte_processo AS pp\n                        ON pp.cod_parte_processo = ti.cod_parte_processo\n                     WHERE ti.cod_empresa = p.cod_empresa\n                       AND ti.num_processo = p.num_processo\n                       AND pp.sts_empresa_operadora = '1'\n                   )\n   AND ( mn.cod_modulo != '4'\n         OR NOT ( ( NOT EXISTS ( SELECT 1\n                                   FROM silver.autor AS a\n                                   JOIN silver.parte_processo AS pp\n                                     ON pp.cod_parte_processo = a.cod_parte_processo\n                                  WHERE a.num_processo = p.num_processo\n                                    AND a.cod_empresa = p.cod_empresa\n                                    AND pp.sts_empresa_operadora = '1'\n                               )\n                  )\n                  AND ( NOT EXISTS ( SELECT 1\n                                       FROM silver.reu AS r\n                                       JOIN silver.parte_processo AS pp\n                                         ON pp.cod_parte_processo = r.cod_parte_processo\n                                      WHERE r.num_processo = p.num_processo\n                                        AND r.cod_empresa = p.cod_empresa\n                                        AND pp.sts_empresa_operadora = '1'\n                                   )\n                      )\n                  AND ( EXISTS ( SELECT 1\n                                   FROM silver.vitima AS v\n                                   JOIN silver.parte_processo AS pp\n                                     ON pp.cod_parte_processo = v.cod_parte_processo\n                                  WHERE v.num_processo = p.num_processo\n                                    AND v.cod_empresa = p.cod_empresa\n                                    AND pp.sts_empresa_operadora = '1'\n                               )\n                      )\n                )\n       )\n   AND ( CAST(log_dtc_citacao AS DATE) <= ( SELECT top 1 cmAtual.dtc_final\n                                            FROM silver.calendario_monetario cmAtual\n                                            WHERE cmAtual.cod_calendario_monetario = @cod_calendario\n                                                )\n         OR log_dtc_citacao IS NULL \n       )\n   and ((sts_area_responsavel is null) or (sts_area_responsavel is not null and sts_area_responsavel <> 'REG'))\n   and (sts_area_responsavel_geral is null or sts_area_responsavel_geral <> 'PSE')\n   group by p.cod_divisao_processo, p.sig_escritorio_contratado,cod_calendario_monetario,d.pos,cm.dtc_inicial,cm.dtc_final\n   ,cm.dtc_limite_foto ,cm.nom_usuario_cadastro,\n      d.nom_escritorio_contratado,   c.sig_divisao,   c.nom_divisao , cm.desc_calendario    \n\n\nINSERT INTO ft_agg_pre_fotografia\n\nSELECT\n\nCOD_DIVISAO_PROCESSO,\n\nNULL,\n\nSIG_ESCRITORIO_CONTRATADO,\n\n2,\n\n@cod_calendario,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nNULL,\n\nCONCAT(SIG_ESCRITORIO_CONTRATADO,COD_DIVISAO_PROCESSO,COD_CALENDARIO_MONETARIO)\n\nFROM\n\nSILVER.fotografias_possiveis\n\nWHERE\n\nCONCAT(SIG_ESCRITORIO_CONTRATADO,COD_DIVISAO_PROCESSO,COD_CALENDARIO_MONETARIO) NOT IN (\n\n        SELECT DISTINCT\n\n        CONCAT(SIG_ESCRITORIO_CONTRATADO,COD_DIVISAO_PROCESSO,COD_CALENDARIO_MONETARIO)\n\n        FROM\n\n        ft_agg_pre_fotografia\n\n        WHERE\n        COD_CALENDARIO_MONETARIO = @cod_calendario)\nAND\nCOD_CALENDARIO_MONETARIO = @cod_calendario;\n\nupdate ft_agg_pre_fotografia \nset qtd_processo = b.qtd_processo,\n     cod_status = 1 \nfrom ft_agg_pre_fotografia a,\nsilver.fotografias_possiveis b\nwhere a.cod_calendario_monetario = @cod_calendario\nand a.cod_divisao_processo = b.cod_divisao_processo\nand a.sig_escritorio_contratado = b.sig_escritorio_contratado \nand a.cod_calendario_monetario = b.cod_calendario_monetario\nand ( a.qtd_processo is null or a.qtd_processo = 0  )\n    \n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}