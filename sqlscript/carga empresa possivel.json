{
	"name": "carga empresa possivel",
	"properties": {
		"content": {
			"query": "DECLARE @dtc_cadastro_prox_d_util AS DATE,\n@cod_calendario as numeric\n\nSelect @cod_calendario =  cod_calendario_monetario \nfrom silver.calendario_monetario\nwhere sts_ativo = 1 \n\nSET @dtc_cadastro_prox_d_util = ( SELECT TOP 1 CAST(dtc_final as date) AS dtc_final\n                                    FROM Silver.calendario_monetario\n                                    WHERE cod_calendario_monetario = @cod_calendario\n\t\t\t\t\t\t\t\t)\n\nIF (@dtc_cadastro_prox_d_util IS NULL)\n        THROW 50000, 'Data_Final: Nao existe calendario monetario para a data selecionada' , 1;\n\n    WHILE 1 = 1\n    BEGIN\n        IF DATEPART(WEEKDAY, @dtc_cadastro_prox_d_util) NOT IN (7, 1)\n           AND FORMAT(@dtc_cadastro_prox_d_util, 'ddMM') NOT IN (SELECT FORMAT(dtc_feriado, 'ddMM') FROM silver.feriado)\n          BREAK\n    \tSET @dtc_cadastro_prox_d_util = DATEADD(DAY, 1, @dtc_cadastro_prox_d_util)\n    END\n\nINSERT INTO silver.empresa_possiveis\n(\t[COD_EMPRESA] ,\n\t[COD_CALENDARIO_MONETARIO],\n\t[OPERACAO] )\nSELECT distinct \n   p.cod_empresa,\n   cm.cod_calendario_monetario,\n   e.operacao\n  FROM \n    dbo.dm_divisao_processo c,\n  silver.escritorio_contratado d,\n  silver.tb_empresa e,\n  --silver.escritorio_contratado_sap e ,\n  silver.processo AS p\n\n  JOIN silver.calendario_monetario AS cm ON cm.cod_calendario_monetario = @cod_calendario\n  JOIN silver.modulo_natureza AS mn\n  ON mn.cod_natureza = p.cod_natureza\n  AND mn.cod_especificacao_natureza = p.cod_especificacao_natureza\n  AND mn.cod_detalhe_especific_natureza = p.cod_detalhe_especific_natureza\n  JOIN silver.modulo AS m\n    ON m.cod_modulo = mn.cod_modulo\n  WHERE p.sts_excluido = '0'\n  and e.cod_empresa = p.cod_empresa\n  and d.sig_escritorio_contratado =  p.sig_escritorio_contratado\n -- and e.sig_escritorio_contratado =  p.sig_escritorio_contratado\n  and p.cod_divisao_processo = c.cod_divisao_processo\n   and p.cod_divisao_processo > 0\n\n   AND ( ( p.sts_ativo = '1' AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util )\n         OR ( p.sts_ativo = '0'\n              AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util\n              AND CAST(p.dtc_fim AS DATE) >= @dtc_cadastro_prox_d_util\n            )\n         OR ( p.sts_ativo = '2'\n              AND CAST(p.dtc_cadastro AS DATE) < @dtc_cadastro_prox_d_util\n              AND CAST(p.dtc_arquivamento AS DATE) >= @dtc_cadastro_prox_d_util\n            )\n       )\n   AND ( mn.cod_modulo != '5'\n         OR ( p.cod_tipo_acao_processo <> '51'\n              OR p.cod_tipo_acao_processo IS NULL\n            )\n       )\n   AND NOT ( p.cod_natureza = '100'\n             AND p.cod_especificacao_natureza = '3'\n             AND p.cod_detalhe_especific_natureza = '6'\n           )\n   AND NOT EXISTS ( SELECT 1\n                      FROM silver.terceiro_interessado AS ti\n                      JOIN silver.parte_processo AS pp\n                        ON pp.cod_parte_processo = ti.cod_parte_processo\n                     WHERE ti.cod_empresa = p.cod_empresa\n                       AND ti.num_processo = p.num_processo\n                       AND pp.sts_empresa_operadora = '1'\n                   )\n   AND ( mn.cod_modulo != '4'\n         OR NOT ( ( NOT EXISTS ( SELECT 1\n                                   FROM silver.autor AS a\n                                   JOIN silver.parte_processo AS pp\n                                     ON pp.cod_parte_processo = a.cod_parte_processo\n                                  WHERE a.num_processo = p.num_processo\n                                    AND a.cod_empresa = p.cod_empresa\n                                    AND pp.sts_empresa_operadora = '1'\n                               )\n                  )\n                  AND ( NOT EXISTS ( SELECT 1\n                                       FROM silver.reu AS r\n                                       JOIN silver.parte_processo AS pp\n                                         ON pp.cod_parte_processo = r.cod_parte_processo\n                                      WHERE r.num_processo = p.num_processo\n                                        AND r.cod_empresa = p.cod_empresa\n                                        AND pp.sts_empresa_operadora = '1'\n                                   )\n                      )\n                  AND ( EXISTS ( SELECT 1\n                                   FROM silver.vitima AS v\n                                   JOIN silver.parte_processo AS pp\n                                     ON pp.cod_parte_processo = v.cod_parte_processo\n                                  WHERE v.num_processo = p.num_processo\n                                    AND v.cod_empresa = p.cod_empresa\n                                    AND pp.sts_empresa_operadora = '1'\n                               )\n                      )\n                )\n       )\n   AND ( CAST(log_dtc_citacao AS DATE) <= ( SELECT top 1 cmAtual.dtc_final\n                                            FROM silver.calendario_monetario cmAtual\n                                            WHERE cmAtual.cod_calendario_monetario = @cod_calendario\n                                                )\n         OR log_dtc_citacao IS NULL \n       )\n\n\t   /*\n\n   group by p.cod_divisao_processo, p.sig_escritorio_contratado,cod_calendario_monetario,d.pos,cm.dtc_inicial,cm.dtc_final\n   ,cm.dtc_limite_foto ,cm.nom_usuario_cadastro,\n      d.nom_escritorio_contratado,   c.sig_divisao,   c.nom_divisao , cm.desc_calendario    \n\t  */",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "syndpjarvisprod",
				"poolName": "syndpjarvisprod"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}